# Embedding 图录制测试使用指南

## 🚀 快速开始

### 运行测试

```bash
cd /home/zhuyue/codes/InfiniCore
python test/infinicore/nn/test_embedding_graph_recording.py
```

---

## 📊 改动前后对比

### ❌ 改动前：不支持图录制

#### 1. 运行测试

```bash
python test/infinicore/nn/test_embedding_graph_recording.py
```

#### 2. 预期输出

```
============================================================
Embedding 图录制支持验证
============================================================
============================================================
测试 Embedding 图录制支持
============================================================

1. 输入张量信息:
   - Shape: [4, 32]
   - Device: cuda
   - Dtype: int64

2. 尝试 CUDA Graph 录制...
   使用 PyTorch CUDA Graph API 测试...
   ✗ 图录制失败: [错误信息]
   ✗ Embedding 不支持 CUDA Graph 录制（可能包含同步操作）

3. 简化验证：检查异步操作支持
   ✓ 输入在设备上
   ⚠ 操作可能包含同步点（事件立即完成）  ← 关键：说明有同步操作
   ✓ Forward 执行时间: X.XXX ms
   ✓ 输出形状: [4, 32, 128]
   ✓ 输出设备: cuda
   ✗ 输出验证失败

============================================================
测试 Embedding 设备端输入支持
============================================================

测试 1: 设备端输入
   ✗ 设备端输入失败: [错误信息]

============================================================
测试结果总结
============================================================
CUDA Graph 录制: ✗ 失败
设备端输入: ✗ 失败
============================================================
✗ 部分测试失败，Embedding 可能不完全支持图录制
============================================================
```

#### 3. 关键失败点

- **图录制失败**：因为代码中有 `indices->to(cpu_device)` 同步操作
- **设备端输入失败**：需要先将输入拷贝到 CPU
- **异步验证显示同步点**：事件立即完成，说明有同步操作

---

### ✅ 改动后：支持图录制

#### 1. 运行测试

```bash
python test/infinicore/nn/test_embedding_graph_recording.py
```

#### 2. 预期输出

```
============================================================
Embedding 图录制支持验证
============================================================
============================================================
测试 Embedding 图录制支持
============================================================

1. 输入张量信息:
   - Shape: [4, 32]
   - Device: cuda
   - Dtype: int64

2. 尝试 CUDA Graph 录制...
   使用 PyTorch CUDA Graph API 测试...
   ✓ 成功完成图录制！
   ✓ Embedding 支持 CUDA Graph 录制
   ✓ 图可以成功重放

============================================================
测试 Embedding 设备端输入支持
============================================================

测试 1: 设备端输入
   ✓ 设备端输入成功
   - 输入设备: cuda
   - 输出设备: cuda
   - 输出形状: [1, 5, 64]

============================================================
测试结果总结
============================================================
CUDA Graph 录制: ✓ 通过
设备端输入: ✓ 通过
============================================================
✓ 所有测试通过！Embedding 支持图录制
============================================================
```

#### 3. 关键成功点

- **图录制成功**：所有操作都是异步的，无同步点
- **设备端输入成功**：直接支持设备端输入，无需拷贝
- **图可以重放**：验证图录制的正确性

---

## 🔍 如何判断当前是改动前还是改动后？

### 方法 1: 代码检查（最快）

```bash
# 检查是否有同步操作
grep -n "to(cpu_device)" src/infinicore/nn/embedding.cc

# 结果解读：
# - 有输出 → ❌ 改动前（不支持图录制）
# - 无输出 → ✅ 改动后（支持图录制）
```

### 方法 2: 检查设备端实现

```bash
# 检查是否有设备端 CUDA kernel
ls src/infiniop/ops/embedding/nvidia/embedding_nvidia.cu

# 结果解读：
# - 不存在 → ❌ 改动前（不支持图录制）
# - 存在 → ✅ 改动后（支持图录制）
```

### 方法 3: 运行测试（最准确）

```bash
python test/infinicore/nn/test_embedding_graph_recording.py

# 查看 "CUDA Graph 录制" 测试结果：
# - ✓ 通过 → ✅ 改动后（支持图录制）
# - ✗ 失败 → ❌ 改动前（不支持图录制）
```

---

## 📝 测试内容详解

### 测试 1: CUDA Graph 录制

**目的**：验证 embedding 是否可以在 CUDA Graph 中录制

**工作原理**：
1. 使用 PyTorch 的 `torch.cuda.CUDAGraph()` API
2. 在图录制模式下执行 `embedding.forward()`
3. 如果包含同步操作，录制会失败
4. 如果完全异步，录制会成功

**改动前**：
- ❌ 录制失败：因为 `indices->to(cpu_device)` 触发同步

**改动后**：
- ✅ 录制成功：使用设备端 CUDA kernel，完全异步

### 测试 2: 设备端输入支持

**目的**：验证 embedding 是否支持设备端输入

**工作原理**：
1. 创建设备端的 `input_ids`
2. 直接调用 `embedding.forward(input_ids)`
3. 检查是否成功且输出在设备上

**改动前**：
- ❌ 可能需要先将输入拷贝到 CPU（同步操作）

**改动后**：
- ✅ 直接支持设备端输入（完全异步）

### 测试 3: 异步操作验证（备用）

**目的**：当 CUDA Graph API 不可用时，使用事件验证异步性

**工作原理**：
1. 使用 `DeviceEvent` 记录操作时间
2. 检查操作是否立即完成（同步）或异步执行

**改动前**：
- ⚠️ 事件立即完成，说明有同步操作

**改动后**：
- ✅ 事件未立即完成，说明是异步操作

---

## 🛠️ 故障排查

### 问题 1: PyTorch 版本不支持 CUDA Graph

**现象**：
```
⚠ PyTorch 版本不支持 torch.cuda.graph，使用简化验证方法
```

**解决**：
- 需要 PyTorch 2.0+ 版本
- 测试会自动降级到简化验证方法
- 简化验证也能检测是否支持图录制

### 问题 2: CUDA 不可用

**现象**：
```
⚠ CUDA 不可用，跳过图录制测试
```

**解决**：
- 确保 CUDA 设备可用
- 测试需要 CUDA 环境

### 问题 3: 测试失败但不确定原因

**检查清单**：
1. ✅ 确认代码已编译（特别是 CUDA 支持）
2. ✅ 确认 CUDA 设备可用
3. ✅ 检查 `src/infinicore/nn/embedding.cc` 是否还有 `to(cpu_device)`
4. ✅ 检查是否有 `src/infiniop/ops/embedding/nvidia/embedding_nvidia.cu`

---

## 💡 快速验证脚本

创建一个简单的验证脚本：

```bash
#!/bin/bash
# quick_check.sh

cd /home/zhuyue/codes/InfiniCore

echo "=== 1. 代码检查 ==="
if grep -q "to(cpu_device)" src/infinicore/nn/embedding.cc; then
    echo "❌ 改动前：发现同步操作 to(cpu_device)"
else
    echo "✅ 改动后：无同步操作"
fi

echo ""
echo "=== 2. 设备端实现检查 ==="
if [ -f "src/infiniop/ops/embedding/nvidia/embedding_nvidia.cu" ]; then
    echo "✅ 改动后：有设备端 CUDA kernel"
else
    echo "❌ 改动前：无设备端 CUDA kernel"
fi

echo ""
echo "=== 3. 运行测试 ==="
python test/infinicore/nn/test_embedding_graph_recording.py
```

使用方法：
```bash
chmod +x quick_check.sh
./quick_check.sh
```

---

## 📋 总结

### 改动前特征

| 检查项 | 结果 |
|--------|------|
| 代码中有 `to(cpu_device)` | ✅ 有 |
| 有设备端 CUDA kernel | ❌ 无 |
| 图录制测试 | ❌ 失败 |
| 设备端输入 | ❌ 失败 |

### 改动后特征

| 检查项 | 结果 |
|--------|------|
| 代码中有 `to(cpu_device)` | ❌ 无 |
| 有设备端 CUDA kernel | ✅ 有 |
| 图录制测试 | ✅ 成功 |
| 设备端输入 | ✅ 成功 |

### 最简单的判断方法

**运行测试脚本**，查看 "CUDA Graph 录制" 测试结果：
- ✅ **通过** → 支持图录制（改动后）
- ❌ **失败** → 不支持图录制（改动前）

